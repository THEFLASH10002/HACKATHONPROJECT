{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bison Serve - Patient Information</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <link rel="icon" type="image/png" href="{% static 'favicon.png' %}" alt="Bison Serve Favicon">

    <!-- Leaflet CSS (for the map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <meta name="description" content="Patient information entry form for healthcare providers">
    <meta name="keywords" content="patient information, healthcare, medical form">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s;
        }
        .dark-mode {
            background-color: #2a2a2a;
            color: #f4f4f4;
        }
        .dark-mode section {
            background: #3a3a3a;
            color: #f4f4f4;
        }
        .dark-mode h2, .dark-mode h3 {
            color: #f4f4f4;
        }
        .dark-mode input, .dark-mode select, .dark-mode textarea {
            background-color: #4a4a4a;
            color: #f4f4f4;
            border-color: #555;
        }
        nav {
            background: #0057b3;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        nav a {
            color: white;
            text-decoration: none;
            padding: 15px 25px;
            display: inline-block;
            font-size: 16px;
            transition: background-color 0.3s;
            border-radius: 5px;
        }
        nav a:hover {
            background-color: #003d7a;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 90%;
        }
        .progress-bar {
            width: 0;
            height: 20px;
            background-color: #0057b3;
            border-radius: 10px;
            transition: width 0.3s;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 14px;
        }
        form {
            max-width: 90%;
            margin: auto;
            padding: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }
        section {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            border-radius: 10px;
            background: #eef3f7;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        section:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .image-upload {
            text-align: center;
            margin-bottom: 20px;
        }
        .preview-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 10px auto;
        }
        .preview-container img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ccc;
            transition: transform 0.3s;
        }
        .preview-container:hover img {
            transform: scale(1.1);
        }
        .upload-btn {
            display: inline-block;
            padding: 8px 15px;
            background: #0057b3;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }
        .upload-btn:hover {
            background: #003d7a;
        }
        input[type="file"] {
            display: none;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            transition: border 0.3s, box-shadow 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #0057b3;
            box-shadow: 0 0 5px rgba(0,87,179,0.5);
            outline: none;
        }
        input[type="submit"] {
            background: #0057b3;
            color: white;
            border: none;
            cursor: pointer;
            padding: 15px;
            font-size: 18px;
            width: 100%;
            border-radius: 5px;
            transition: background 0.3s;
            margin-top: 20px;
        }
        input[type="submit"]:hover {
            background: #003d7a;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            max-width: 90%;
            margin: 20px auto;
        }
        .btn {
            padding: 10px 20px;
            background: #0057b3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #003d7a;
        }
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        footer {
            text-align: center;
            padding: 15px;
            background: #333;
            color: white;
            margin-top: 30px;
        }
        .error {
            color: red;
            font-size: 14px;
            margin-top: 5px;
        }
        .success {
            color: green;
            font-size: 16px;
            text-align: center;
            padding: 15px;
            margin: 20px auto;
            max-width: 90%;
            background-color: rgba(0,128,0,0.1);
            border-radius: 5px;
            display: none;
        }
        .bmi-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .normal {
            background-color: #d4edda;
            color: #155724;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: pointer;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        .theme-toggle {
            position: absolute;
            right: 20px;
            top: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: #0057b3;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(200%);
            transition: transform 0.5s;
        }
        .notification.show {
            transform: translateX(0);
        }
        /* Test data controls */
        .test-controls {
            max-width: 90%;
            margin: 20px auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px dashed #0057b3;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        .dark-mode .test-controls {
            background-color: #3a3a3a;
            border-color: #6c757d;
        }
        .test-btn {
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .test-btn:hover {
            background: #218838;
        }
        .test-btn.clear {
            background: #dc3545;
        }
        .test-btn.clear:hover {
            background: #c82333;
        }
        .test-btn.edit {
            background: #ffc107;
            color: #212529;
        }
        .test-btn.edit:hover {
            background: #e0a800;
        }
        /* Edit mode indicator */
        .edit-mode-indicator {
            padding: 5px 10px;
            background-color: #ffc107;
            color: #212529;
            border-radius: 5px;
            font-weight: bold;
            display: none;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        /* Modal for edit history */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .dark-mode .modal-content {
            background-color: #3a3a3a;
            color: #f4f4f4;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #555;
        }
        .edit-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 15px;
        }
        .edit-record {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .edit-record:last-child {
            border-bottom: none;
        }
        .edit-field {
            font-weight: bold;
            color: #0057b3;
        }
        .edit-old {
            text-decoration: line-through;
            color: #dc3545;
        }
        .edit-new {
            color: #28a745;
        }
        .dark-mode .edit-field {
            color: #8ab4f8;
        }
        .dark-mode .edit-old {
            color: #f8a8a8;
        }
        .dark-mode .edit-new {
            color: #a8f8a8;
        }
    </style>
</head>

<body>
    <nav>
        <a href="{% url 'home' %}" class="nav-link">Bison Serve Homepage</a>
        <a href="{% url 'service_match' %}" class="nav-link">Find a Tutor</a>
        <a href="{% url 'service_opportunities' %}" class="nav-link">Service Opportunities</a>
        <button class="theme-toggle" id="theme-toggle">üåô</button>
    </nav>

    <div class="container">
        <h2>Patient Information <span class="edit-mode-indicator" id="edit-mode-indicator">Edit Mode</span></h2>
        
        <!-- Test Controls -->
        <div class="test-controls">
            <button id="load-test-data" class="test-btn">Load Test Data</button>
            <button id="clear-form" class="test-btn clear">Clear All Fields</button>
            <button id="toggle-edit-mode" class="test-btn edit">Toggle Edit Mode</button>
            <button id="show-edit-history" class="test-btn">View Edit History</button>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>
        
        <div class="notification" id="notification">Form is being filled. Keep going!</div>

        <form id="patient-form">
            <div class="form-section active" id="section-1">
                <section>
                    <h3>Personal Information</h3>
                    <div class="form-group">
                        <label for="patient-picture">Patient Picture:</label>
                        <div class="image-upload">
                            <input type="file" id="patient-picture" name="patient-picture" accept="image/*">
                            <div class="preview-container">
                                <img id="preview-image" src="{% static 'default-profile.png' %}" alt="Patient Picture Preview">
                            </div>
                            <label for="patient-picture" class="upload-btn">Choose Image</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="patient-name">Patient Name: <span class="tooltip">‚ìò<span class="tooltiptext">Enter full legal name</span></span></label>
                        <input type="text" id="patient-name" name="patient-name" placeholder="Full Name">
                        <div id="name-error" class="error"></div>
                    </div>

                    <div class="form-group">
                        <label for="patient-date-of-birth">Date of Birth:</label>
                        <input type="date" id="patient-date-of-birth" name="patient-date-of-birth">
                        <div id="dob-error" class="error"></div>
                    </div>

                    <div class="form-group">
                        <label for="patient-age">Age:</label>
                        <input type="number" id="patient-age" name="patient-age" readonly>
                    </div>

                    <div class="form-group">
                        <label for="patient-gender">Gender:</label>
                        <select id="patient-gender" name="patient-gender">
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                        <div id="gender-error" class="error"></div>
                    </div>
                </section>
            </div>

            <div class="form-section" id="section-2">
                <section>
                    <h3>Medical Information</h3>
                    <div class="form-group">
                        <label for="patient-weight">Weight (lbs):</label>
                        <input type="number" id="patient-weight" name="patient-weight" min="0" placeholder="Enter weight in pounds">
                        <div id="weight-error" class="error"></div>
                    </div>

                    <div class="form-group">
                        <label for="patient-height">Height (inches):</label>
                        <input type="number" id="patient-height" name="patient-height" min="0" placeholder="Enter height in inches">
                        <div id="height-error" class="error"></div>
                    </div>

                    <div class="form-group">
                        <label for="patient-blood-type">Blood Type:</label>
                        <select id="patient-blood-type" name="patient-blood-type">
                            <option value="">Select Blood Type</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                        <div id="blood-type-error" class="error"></div>
                    </div>

                    <div id="bmi-result" class="bmi-result" style="display: none;"></div>
                </section>

                <section>
                    <h3>Medical History</h3>
                    <div class="form-group">
                        <label for="patient-medical-history">Medical History:</label>
                        <textarea id="patient-medical-history" name="patient-medical-history" rows="4" placeholder="Enter any relevant medical history information"></textarea>
                        <div id="medical-history-error" class="error"></div>
                    </div>

                    <div class="form-group">
                        <label for="patient-allergies">Allergies:</label>
                        <textarea id="patient-allergies" name="patient-allergies" rows="2" placeholder="List any allergies"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="patient-current-medications">Current Medications:</label>
                        <textarea id="patient-current-medications" name="patient-current-medications" rows="4" placeholder="List all current medications and dosages"></textarea>
                        <div id="medications-error" class="error"></div>
                    </div>
                </section>
            </div>

            <div class="form-section" id="section-3">
                <section>
                    <h3>Vital Signs</h3>
                    <div class="form-group">
                        <label for="heart-rate">Heart Rate (BPM): <span class="tooltip">‚ìò<span class="tooltiptext">Normal range: 60-100 BPM</span></span></label>
                        <input type="number" id="heart-rate" name="heart-rate" min="30" max="200" placeholder="Enter heart rate">
                        <div id="heart-rate-error" class="error"></div>
                    </div>

                    <div class="form-group">
                        <label for="blood-pressure-systolic">Blood Pressure (Systolic): <span class="tooltip">‚ìò<span class="tooltiptext">Upper number, normal is < 120</span></span></label>
                        <input type="number" id="blood-pressure-systolic" name="blood-pressure-systolic" min="70" max="200" placeholder="Systolic (upper number)">
                        <div id="bp-systolic-error" class="error"></div>
                    </div>

                    <div class="form-group">
                        <label for="blood-pressure-diastolic">Blood Pressure (Diastolic): <span class="tooltip">‚ìò<span class="tooltiptext">Lower number, normal is < 80</span></span></label>
                        <input type="number" id="blood-pressure-diastolic" name="blood-pressure-diastolic" min="40" max="120" placeholder="Diastolic (lower number)">
                        <div id="bp-diastolic-error" class="error"></div>
                    </div>

                    <div class="form-group">
                        <label for="oxygen-level">Oxygen Level (%): <span class="tooltip">‚ìò<span class="tooltiptext">Normal range: 95-100%</span></span></label>
                        <input type="number" id="oxygen-level" name="oxygen-level" min="80" max="100" placeholder="Enter oxygen level">
                        <div id="oxygen-level-error" class="error"></div>
                    </div>

                    <div class="form-group">
                        <label for="temperature">Temperature (¬∞F): <span class="tooltip">‚ìò<span class="tooltiptext">Normal is 98.6¬∞F</span></span></label>
                        <input type="number" id="temperature" name="temperature" min="95" max="105" step="0.1" placeholder="Enter temperature">
                    </div>
                </section>

                <section>
                    <h3>Emergency Contact</h3>
                    <div class="form-group">
                        <label for="emergency-contact-name">Emergency Contact Name:</label>
                        <input type="text" id="emergency-contact-name" name="emergency-contact-name" placeholder="Full Name">
                    </div>

                    <div class="form-group">
                        <label for="emergency-contact-relationship">Relationship:</label>
                        <input type="text" id="emergency-contact-relationship" name="emergency-contact-relationship" placeholder="e.g., Spouse, Parent, Child">
                    </div>

                    <div class="form-group">
                        <label for="emergency-contact-phone">Phone Number:</label>
                        <input type="tel" id="emergency-contact-phone" name="emergency-contact-phone" placeholder="(123) 456-7890">
                        <div id="contact-phone-error" class="error"></div>
                    </div>
                </section>
            </div>
        </form>

        <div class="controls">
            <button id="prev-btn" class="btn" disabled>Previous</button>
            <button id="next-btn" class="btn">Next</button>
            <button id="submit-btn" class="btn" style="display: none;">Submit</button>
        </div>

        <div id="form-feedback" class="success"></div>
    </div>

    <!-- Edit History Modal -->
    <div id="edit-history-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-modal">&times;</span>
            <h3>Edit History</h3>
            <div id="edit-history-content" class="edit-history">
                <!-- Edit history will be populated here -->
                <p>No edits have been made yet.</p>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Bison Serve. All rights reserved.</p>
        <p>Contact us at <a href="mailto:info@bisonserves.com">info@bisonserves.com</a></p>
    </footer>

    <script>
        // Initialize variables for multi-step form
        let currentSection = 1;
        const totalSections = 3;
        let editMode = false;
        let editHistory = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress();
            
            // Theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                themeToggle.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
            });
            
            // Navigation buttons
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');
            
            prevBtn.addEventListener('click', goToPrevSection);
            nextBtn.addEventListener('click', goToNextSection);
            submitBtn.addEventListener('click', submitForm);
            
            // Test controls
            document.getElementById('load-test-data').addEventListener('click', loadTestData);
            document.getElementById('clear-form').addEventListener('click', clearForm);
            document.getElementById('toggle-edit-mode').addEventListener('click', toggleEditMode);
            document.getElementById('show-edit-history').addEventListener('click', showEditHistory);
            
            // Modal close button
            document.getElementById('close-modal').addEventListener('click', closeModal);
            
            // Close modal when clicking outside of it
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('edit-history-modal');
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            // Profile picture preview
            document.getElementById("patient-picture").addEventListener("change", function(event) {
                const reader = new FileReader();
                reader.onload = function() {
                    document.getElementById("preview-image").src = reader.result;
                };
                reader.readAsDataURL(event.target.files[0]);
                showNotification("Profile picture uploaded successfully!");
            });
            
            // Calculate age automatically
            document.getElementById("patient-date-of-birth").addEventListener("change", function() {
                const dob = new Date(this.value);
                const age = calculateAge(dob);
                document.getElementById("patient-age").value = age;
                if (age < 18) {
                    showNotification("Please note: Patient is a minor.");
                }
            });
            
            // Calculate BMI when height and weight are entered
            const weightInput = document.getElementById("patient-weight");
            const heightInput = document.getElementById("patient-height");
            
            [weightInput, heightInput].forEach(input => {
                input.addEventListener("input", calculateBMI);
            });
            
            // Monitor form progress
            const formInputs = document.querySelectorAll('input:not([type="file"]), select, textarea');
            formInputs.forEach(input => {
                input.addEventListener('change', function() {
                    updateProgress();
                    
                    // Track edits in edit mode
                    if (editMode && this.dataset.origValue !== undefined && this.value !== this.dataset.origValue) {
                        recordEdit(this.name, this.dataset.origValue, this.value);
                        this.dataset.origValue = this.value;
                    }
                });
                
                // Setup for edit tracking
                input.dataset.origValue = input.value;
            });
            
            // Phone number formatting
            document.getElementById("emergency-contact-phone").addEventListener("input", function(e) {
                var x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
            });
        });
        
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function calculateAge(dob) {
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const month = today.getMonth();
            const day = today.getDate();

            if (month < dob.getMonth() || (month === dob.getMonth() && day < dob.getDate())) {
                age--;
            }

            return age;
        }
        
        function calculateBMI() {
            const weightLbs = parseFloat(document.getElementById("patient-weight").value);
            const heightInches = parseFloat(document.getElementById("patient-height").value);
            const bmiResult = document.getElementById("bmi-result");
            
            if (weightLbs > 0 && heightInches > 0) {
                // BMI formula: (weight in kg / (height in meters)^2)
                // Convert lbs to kg: weight / 2.2046
                // Convert inches to meters: height * 0.0254
                const weightKg = weightLbs / 2.2046;
                const heightMeters = heightInches * 0.0254;
                const bmi = weightKg / (heightMeters * heightMeters);
                const roundedBMI = bmi.toFixed(1);
                
                bmiResult.style.display = "block";
                bmiResult.textContent = `BMI: ${roundedBMI}`;
                
                if (bmi < 18.5) {
                    bmiResult.className = "bmi-result warning";
                    bmiResult.textContent += " (Underweight)";
                } else if (bmi >= 18.5 && bmi < 25) {
                    bmiResult.className = "bmi-result normal";
                    bmiResult.textContent += " (Normal)";
                } else if (bmi >= 25 && bmi < 30) {
                    bmiResult.className = "bmi-result warning";
                    bmiResult.textContent += " (Overweight)";
                } else {
                    bmiResult.className = "bmi-result danger";
                    bmiResult.textContent += " (Obese)";
                }
                
                if (editMode) {
                    showNotification("BMI updated: " + roundedBMI);
                }
            } else {
                bmiResult.style.display = "none";
            }
        }
        // Navigation functions
function goToPrevSection() {
    if (currentSection > 1) {
        document.getElementById(`section-${currentSection}`).classList.remove('active');
        currentSection--;
        document.getElementById(`section-${currentSection}`).classList.add('active');
        updateNavButtons();
    }
}

function goToNextSection() {
    if (validateCurrentSection() && currentSection < totalSections) {
        document.getElementById(`section-${currentSection}`).classList.remove('active');
        currentSection++;
        document.getElementById(`section-${currentSection}`).classList.add('active');
        updateNavButtons();
        showNotification(`Section ${currentSection} of ${totalSections}`);
    }
}

function updateNavButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    
    prevBtn.disabled = (currentSection === 1);
    
    if (currentSection === totalSections) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'block';
    } else {
        nextBtn.style.display = 'block';
        submitBtn.style.display = 'none';
    }
    
    updateProgress();
}

// Validation function
function validateCurrentSection() {
    let isValid = true;
    const currentSectionEl = document.getElementById(`section-${currentSection}`);
    
    // Clear previous errors
    const errorElements = currentSectionEl.querySelectorAll('.error');
    errorElements.forEach(el => el.textContent = '');
    
    // Validate fields based on the current section
    if (currentSection === 1) {
        // Check name
        const nameInput = document.getElementById('patient-name');
        if (!nameInput.value.trim()) {
            document.getElementById('name-error').textContent = 'Name is required';
            isValid = false;
        }
        
        // Check DOB
        const dobInput = document.getElementById('patient-date-of-birth');
        if (!dobInput.value) {
            document.getElementById('dob-error').textContent = 'Date of Birth is required';
            isValid = false;
        }
        
        // Check gender
        const genderInput = document.getElementById('patient-gender');
        if (!genderInput.value) {
            document.getElementById('gender-error').textContent = 'Please select a gender';
            isValid = false;
        }
    } 
    else if (currentSection === 2) {
        // Validate medical info section if needed
        const weightInput = document.getElementById('patient-weight');
        if (!weightInput.value || weightInput.value <= 0) {
            document.getElementById('weight-error').textContent = 'Please enter a valid weight';
            isValid = false;
        }
        
        const heightInput = document.getElementById('patient-height');
        if (!heightInput.value || heightInput.value <= 0) {
            document.getElementById('height-error').textContent = 'Please enter a valid height';
            isValid = false;
        }
    }
    else if (currentSection === 3) {
        // Validate vital signs if needed
        const heartRateInput = document.getElementById('heart-rate');
        if (heartRateInput.value && (heartRateInput.value < 30 || heartRateInput.value > 200)) {
            document.getElementById('heart-rate-error').textContent = 'Please enter a valid heart rate (30-200)';
            isValid = false;
        }
        
        // Validate phone format if entered
        const phoneInput = document.getElementById('emergency-contact-phone');
        if (phoneInput.value && !phoneInput.value.match(/^\(\d{3}\) \d{3}-\d{4}$/)) {
            document.getElementById('contact-phone-error').textContent = 'Please enter a valid phone number';
            isValid = false;
        }
    }
    
    if (!isValid) {
        showNotification("Please fix the errors before continuing");
    }
    
    return isValid;
}

// Form submission
function submitForm() {
    if (validateCurrentSection()) {
        // Collect form data
        const formData = new FormData(document.getElementById('patient-form'));
        const formDataObj = {};
        
        for (const [key, value] of formData.entries()) {
            formDataObj[key] = value;
        }
        
        // In a real app, you would send this to your server
        console.log('Submitting patient data:', formDataObj);
        
        // Show success message
        const feedback = document.getElementById('form-feedback');
        feedback.style.display = 'block';
        feedback.textContent = 'Patient information submitted successfully!';
        
        showNotification("Form submitted successfully!");
        
        // Reset form after submission if needed
        // clearForm();
    }
}

// Test data functions
function loadTestData() {
    // Sample test data
    document.getElementById('patient-name').value = 'John Doe';
    document.getElementById('patient-date-of-birth').value = '1980-05-15';
    document.getElementById('patient-age').value = calculateAge(new Date('1980-05-15'));
    document.getElementById('patient-gender').value = 'male';
    
    document.getElementById('patient-weight').value = 180;
    document.getElementById('patient-height').value = 70;
    document.getElementById('patient-blood-type').value = 'O+';
    document.getElementById('patient-medical-history').value = 'Hypertension diagnosed in 2018\nMinor knee surgery in 2015';
    document.getElementById('patient-allergies').value = 'Penicillin, Peanuts';
    document.getElementById('patient-current-medications').value = 'Lisinopril 10mg daily\nAspirin 81mg daily';
    
    document.getElementById('heart-rate').value = 72;
    document.getElementById('blood-pressure-systolic').value = 120;
    document.getElementById('blood-pressure-diastolic').value = 80;
    document.getElementById('oxygen-level').value = 98;
    document.getElementById('temperature').value = 98.6;
    
    document.getElementById('emergency-contact-name').value = 'Jane Doe';
    document.getElementById('emergency-contact-relationship').value = 'Spouse';
    document.getElementById('emergency-contact-phone').value = '(555) 123-4567';
    
    // Calculate BMI
    calculateBMI();
    
    // Update form progress
    updateProgress();
    
    showNotification("Test data loaded successfully!");
}

function clearForm() {
    document.getElementById('patient-form').reset();
    document.getElementById('preview-image').src = "{% static 'default-profile.png' %}";
    document.getElementById('bmi-result').style.display = 'none';
    
    // Clear any error messages
    const errorElements = document.querySelectorAll('.error');
    errorElements.forEach(el => el.textContent = '');
    
    // Return to first section
    if (currentSection !== 1) {
        document.getElementById(`section-${currentSection}`).classList.remove('active');
        currentSection = 1;
        document.getElementById(`section-${currentSection}`).classList.add('active');
        updateNavButtons();
    }
    
    updateProgress();
    showNotification("Form cleared!");
}

// Edit mode functions
function toggleEditMode() {
    editMode = !editMode;
    const indicator = document.getElementById('edit-mode-indicator');
    
    if (editMode) {
        indicator.style.display = 'inline-block';
        showNotification("Edit mode enabled - changes will be tracked");
        
        // Save current values as originals for comparison
        const formInputs = document.querySelectorAll('input:not([type="file"]), select, textarea');
        formInputs.forEach(input => {
            input.dataset.origValue = input.value;
        });
    } else {
        indicator.style.display = 'none';
        showNotification("Edit mode disabled");
    }
}

function recordEdit(fieldName, oldValue, newValue) {
    // Format field name for display
    const formattedFieldName = fieldName
        .replace('patient-', '')
        .split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    
    // Add edit to history
    editHistory.push({
        field: formattedFieldName,
        oldValue: oldValue || '(empty)',
        newValue: newValue || '(empty)',
        timestamp: new Date().toLocaleString()
    });
    
    console.log(`Edit recorded: ${formattedFieldName} changed from "${oldValue}" to "${newValue}"`);
}

function showEditHistory() {
    const modal = document.getElementById('edit-history-modal');
    const content = document.getElementById('edit-history-content');
    
    if (editHistory.length === 0) {
        content.innerHTML = '<p>No edits have been made yet.</p>';
    } else {
        let historyHTML = '';
        
        editHistory.forEach((edit, index) => {
            historyHTML += `
                <div class="edit-record">
                    <span>${index + 1}. <span class="edit-field">${edit.field}</span> changed at ${edit.timestamp}</span><br>
                    <span class="edit-old">From: ${edit.oldValue}</span><br>
                    <span class="edit-new">To: ${edit.newValue}</span>
                </div>
            `;
        });
        
        content.innerHTML = historyHTML;
    }
    
    modal.style.display = 'block';
}

function closeModal() {
    document.getElementById('edit-history-modal').style.display = 'none';
}

// Progress tracking
function updateProgress() {
    const form = document.getElementById('patient-form');
    const requiredFields = form.querySelectorAll('input:required, select:required, textarea:required');
    const allFields = form.querySelectorAll('input:not([type="file"]):not([readonly]), select, textarea');
    
    let filledFields = 0;
    
    allFields.forEach(field => {
        if (field.value.trim() !== '') {
            filledFields++;
        }
    });
    
    const progressPercentage = Math.floor((filledFields / allFields.length) * 100);
    const progressBar = document.getElementById('progress-bar');
    
    progressBar.style.width = `${progressPercentage}%`;
    progressBar.textContent = `${progressPercentage}%`;
    
    // Change color based on progress
    if (progressPercentage < 33) {
        progressBar.style.backgroundColor = '#dc3545'; // Red
    } else if (progressPercentage < 66) {
        progressBar.style.backgroundColor = '#ffc107'; // Yellow
    } else {
        progressBar.style.backgroundColor = '#28a745'; // Green
    }
}